```python
import pandas as pd
from pyktest.tester import Ktest
```

### Ktest definition 

Load data and metadata, and initialize ktest object 
- `data` is the dataframe of data.
- `metadata` is the dataframe of metadata.
- `condition` is the column of `metadata` containing the labels to test. 
- `samples` is the couple of samples to test in the column `condition` of `metadata`
- Set `nystrom` to `True` to use the nystrom approximation. 
- Set `verbose >0`Â to follow the steps of the initialization of the ktest object.  


```python
data = pd.read_csv('data2.csv',index_col=0)
metadata = pd.read_csv('metadata2.csv',index_col=0)

kt = Ktest(data,
           metadata,
           condition='condition',
           samples=['0H','48HREV'],
           verbose=1)

```

    - Add data 'data' to Ktest, dimensions=(344, 83)
    - Set test data info (0H,48HREV from condition)
    - Define kernel function (gauss)


### Multivariate testing 

Perform a multivariate test on the data. 



```python
kt.multivariate_test(verbose=1)
```

    - Initialize kfdat
    	cov : standard 
    	mmd : standard
    - Diagonalize within covariance centered gram
    - Compute within covariance centered gram
    - Compute kfda statistic
    
    ___Multivariate kfda test results___
    Asymptotic p-value(truncation) for multivariate testing : 
    	p-value(10) = 3.9e-23 (kfda=130.41)


#### Print test results 
- `long` : if True, the results are printed for several truncations
- `t` : truncation associated to the printed p-value if `long` is False
- `ts` : list of truncations associated to the printed p-values if `long` is True




```python
kt.print_multivariate_test_results(long=True,ts=[1,2,3])
```

    
    
    ___Multivariate kfda test results___
    Asymptotic p-value(truncation) for multivariate testing : 
    	p-value(1) = 0.61 (kfda=0.26)
    	p-value(2) = 1.1e-08 (kfda=36.66)
    	p-value(3) = 3.9e-16 (kfda=74.87)


#### Plot or get p-values table with respect to the truncation parameter. 

- contrib : if true, returns the p-value associated to each principal component individually. Retruns the p-value associated to the kfda statistic otherwise. 
- log : if true, returns the log p-values. 



```python
kt.get_pvalue(contrib=True,log=False)
```




    1       6.117177e-01
    2       1.246529e-08
    3       2.552708e-08
    4       1.884499e-07
    5       1.101084e-01
               ...      
    340     1.000000e+00
    341     2.100695e-01
    342    7.245134e-242
    343     0.000000e+00
    344     1.000000e+00
    Name: standard_datacondition0H48HREV, Length: 344, dtype: float64



#### Plot p-values with respect to truncation
- `t` : plot the p-values for truncations from 1 to `t`.
- `log` :  if True, plot the log p-values. 
- `aggregated` : if True, plot the p-values of the kfda statistic
- `contrib` : if True, plot the p-values of each principal component individually.
- `truncations_of_interest` : the p-values of this list are written on the graph. 

    **graph customization** : 
    - `legend` : show legends if True.
    - `fig` : the matplotlib figure to use. 
    - `ax` : the matplotlib axis to use.
    - `title` : the axis title. 
    - `color_agg` : color of the aggregated p-value. 
    - `color_uni` : color of the contrib p-value.
    - `ls_agg` : linestyle of the aggregated p-value.
    - `ls_uni` : linestyle of the contrib p-value.
    - `label_agg` : label of the aggregated p-value.
    - `label_uni` : label of the contrib p-value. 


```python
kt.plot_pvalue(t=50,log=True)
```

    /home/drg/work/dev/2022_present_LBMC/project/kernel_test/2023_02_Vignettes_Ktest/.pyenv/lib/python3.10/site-packages/pandas/core/arraylike.py:402: RuntimeWarning: divide by zero encountered in log
      result = getattr(ufunc, method)(*inputs, **kwargs)





    (<Figure size 1200x600 with 1 Axes>,
     <Axes: xlabel='$t$', ylabel='log p-value'>)




    
![png](output_10_2.png)
    


### Other tests
The default p-value is the asymptotic p-value of the `kfda` statistic associated to the truncation parameter `t=10`. To change the default truncation parameter, use the class function `set_truncation`. 


```python
kt.set_truncation(5)
kt.multivariate_test(verbose=1)
```

    Statistic standard_datacondition0H48HREV already computed
    
    ___Multivariate kfda test results___
    Asymptotic p-value(truncation) for multivariate testing : 
    	p-value(5) = 2.2e-24 (kfda=120.75)


 
The asymptotic p-value is available for the `kfda` statistic only. 
The permutation p-value is available for the `kfda` statistic and the `mmd` statistic.

Compute the permutation p-value associated to the choosen statistic : 
- `stat` : choosen statistic among (`kfda`,`mmd`)
- `permutation`: if True, compute the permutation p-value (automatically True if `stat` is `mmd`)
- `n_permutations` : set the number of permutations.
- `seed_permutation` : define the number of random seeds. 
- `n_jobs_permutation` : number of CPU to use for parallelized computation



```python
kt.multivariate_test(
    stat='mmd',
    permutation=True,
    n_permutations=2000,
    seed_permutation=123,
    n_jobs_permutation=3,
    verbose=1)
```

    - Permutation statistic n_permutations=2000 seeds from 123 to 2123 with 3 jobs
    
    ___Multivariate mmd test results___
    Permutation (2000 permutations) p-value for multivariate testing : 0.0



```python
kt.stat
kt.get_pvalue_name()
kt.dict_pval_mmd[kt.get_pvalue_name()]
kt.get_pvalue()
```




    0.0



### Nystrom approximation
Use the nystrom approximation to reduce the computational cost


```python
kt.set_test_params(nystrom=True)
kt.multivariate_test(verbose=1)
```

    - Initialize kfdat
    	cov : nystrom3 
    	mmd : standard
    - Initialize nystrom parameters
    - Compute nystrom landmarks (33 landmarks)
    - Compute nystrom anchors (33 anchors)
    - Diagonalize within covariance centered gram
    - Compute within covariance centered gram
    - Compute kfda statistic
    
    ___Multivariate kfda with nystrom test results___
    Asymptotic p-value(truncation) for multivariate testing : 
    	p-value(5) = 5.1e-18 (kfda=90.55)


Tune each parameter of the nystrom approximation with function `set_test_params` : 
- `nystrom` : if True, use the nystrom approximation
- `n_landmarks` : number of landmarks to use (subsample used to compute the anchors).
- `n_anchors` : number of anchors to use (eigenvectors associated to a matrix defined with the landmarks).
- `landmark_method` : how to choose the landmarks among (`random`,`kmeans`)
- `anchor_basis` : matrix used to define the anchors among 
    - `k` : second moment of the landmarks.
    - `s` : total covariance of the landmarks.
    - `w` : within group covariance of the landmarks.


```python
kt.set_test_params(nystrom=True,
                    n_landmarks=50,
                    n_anchors=50,
                    landmark_method='random',
                    anchor_basis='s')
kt.multivariate_test(verbose=1)

```

    - Initialize kfdat
    	cov : nystrom3 
    	mmd : standard
    - Initialize nystrom parameters
    - Compute nystrom landmarks (49 landmarks)
    - Compute nystrom anchors (49 anchors)
    - Diagonalize within covariance centered gram
    - Compute within covariance centered gram
    - Compute kfda statistic
    
    ___Multivariate kfda with nystrom test results___
    Asymptotic p-value(truncation) for multivariate testing : 
    	p-value(5) = 1.1e-22 (kfda=112.61)


### Kernel function choice

The default kernel is the RBF kernel with median bandwidth. Use `init_kernel_params()` to specify the kernel function with a `dict` of specifications.
- `function` is either a string among [`gauss`,`linear`] or a user specified kernel function.
    - if `function` is `gauss`:
        - `bandwidth` is either the string `median` or a float. 
            - if `bandwidth` is `median`: 
                - `median_coef` is the coefficient such that `bandwidth=median_coef x median` (default is `1`)
- `kernel_name` is the name of the kernel used.  




```python
import torch
from pyktest.base import init_kernel_params

# gauss kernel with median/2 bandwidth
kernel1 = init_kernel_params(function = 'gauss', bandwidth = 'median', median_coef = 1/2)

# linear kernel 
kernel2 = init_kernel_params(function='linear')

# user specified kernel
kernel3 = init_kernel_params(function=lambda x,y: torch.cdist(x,y).exp()+1,kernel_name='useless_kernel')
```


```python
kt = Ktest(data,
           metadata,
           condition='condition',
           samples=['0H','48HREV'],
#            kernel=kernel3,
           verbose=1)

kt.multivariate_test(verbose=1)
```

    - Add data 'data' to Ktest, dimensions=(685, 83)
    - Set test data info (0H,48HREV from condition)
    - Define kernel function (gauss)
    - Initialize kfdat
    	cov : standard 
    	mmd : standard
    - Diagonalize within covariance centered gram
    - Compute within covariance centered gram
    - Compute kfda statistic
    
    ___Multivariate kfda test results___
    Asymptotic p-value(truncation) for multivariate testing : 
    	p-value(10) = 3.9e-23 (kfda=130.41)



```python

```
